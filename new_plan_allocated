SELECT coalesce(nullif(trim(client_id), ''), '-9999') as client_id, pld.plan_number, ach_online_payment_flag, advice_part_elig_allowed, CAST(ein_number as INTEGER) as ein_number, ein_suffix, concat (ein_number, ein_suffix) as ein_full, grp_plan_indicator, grp_product_name, cast(loan_401k_elective_limit as INTEGER) as loan_401k_elective_limit, cast(loan_maximum_amount as DECIMAL(11, 2)) as loan_maximum_amount,cast (state as varchar(255)) as plan_address_state,cast (city as varchar(255)) as plan_address_city,cast (zip as varchar(10)) as plan_address_zip_code, cast( loan_maximum_percent_of_vested_current_value as DECIMAL(3, 2) ) as loan_max_pct_vested_curr_val, cast(loan_minimum_amount as DECIMAL(11, 2)) as loan_minimum_amount, cast(max_deferral_amount as DECIMAL(11, 2)) as max_deferral_amount, cast(max_deferral_percent as DECIMAL(5, 4)) as max_deferral_percent, model_portfolio_fixed_account_flag as model_portfolio_fix_acct_flag, model_portfolio_fixed_account_name as model_portfolio_fix_acct_name, model_portfolio_qdia_model_number as model_portfolio_qdia_model_num, mp_qdia_model_type_ind as model_portf_qdia_tgt_date_ind, plan_administrator_name as plan_administrator_name, cast(null as varchar(100)) as plan_name_line_1, cast(null as VARCHAR(255)) as plan_name_line_2, product_description as grp_product_desc, cast(proposal_mail_date as date) as proposal_mail_date, cast(qdia_effective_date as date) as qdia_effective_date, qdia_option, ease_db_plan_id, financial_engine_fees_ind, 'VRP-SP' as source_system, cast(null as VARCHAR(10)) as admin_system, cast(null as VARCHAR(1)) as employer_stock, cast(null as VARCHAR(1)) as dwe_status, cast(null as VARCHAR(1)) as enh_send_notice_flag, cast(null as VARCHAR(1)) as alternate_acct_number_ind, cast(null as VARCHAR(10)) as hardship_suspension, cast(null as VARCHAR(1)) as initial_notification_srvc_ind, cast(null as DATE) as managed_account_end_date, cast(null as VARCHAR(1)) as managed_account_fee, cast(null as VARCHAR(1)) as managed_account_service_ind, cast(null as DATE) as managed_account_start_date, cast(null as VARCHAR(1)) as money_out_service_model, cast(null as VARCHAR(1)) as voya_send_notices_flag, cast(null as VARCHAR(1)) as permissible_withdrawal_ind, loan_eligibility as loans_allowed_flag, cast(null as INTEGER) as number_loans_allowed, case when cardinality(account_type_code)=1 and account_type_code[0]='ALLOC' then 'N' else 'Y' end as Plan_Unallocated_flag, cast(dss.company_code as VARCHAR(3)) as plan_company_code, cast(null as VARCHAR(1)) as plan_expand_flag, cast(pld.irc_code as VARCHAR(100)) as irc_code, cast(null as VARCHAR(80)) as ma_ama_ria_firm_name, cast(null as VARCHAR(8)) as asset_alloc_made_easy_is_qdia, cast(null as VARCHAR(5)) as qdia_default_fund_iv, cast(null as VARCHAR(5)) as qdia_default_fund_number, cast(null as VARCHAR(1)) as qdia_indicator, cast(null as VARCHAR(10)) as auto_enroll_eaca_qaca_ind, cast(null as VARCHAR(40)) as qdia_portfolio_type_fund_name, cast(null as VARCHAR(1)) as auto_enroll, cast(null as VARCHAR(6)) as billing_group, cast(null as DATE) as source_processing_date,  cast(null as VARCHAR(1)) as crc_type, cast(pr.source_system_field_value_txt as VARCHAR(55)) as irc_code_desc, cast(null as DATE) as plan_issue_date, cast(null as DECIMAL(15, 2)) as dac_override_amount, cast(null as DATE) as end_date, cast(null as VARCHAR(80)) as erisa_flag, cast(null as VARCHAR(1)) as exchange_indicator, cast(null as VARCHAR(30)) as fee_deduction_method, cast(null as VARCHAR(10)) as fiduciary_service_flag,  cast(null as VARCHAR(80)) as fiduciary_services_program, cast(null as VARCHAR(80)) as plan_manager_name, cast(null as VARCHAR(80)) as financial_advisor, cast(null as VARCHAR(80)) as fund_menu, cast(null as VARCHAR(80)) as income_secure_ma_flag, cast(null as VARCHAR(80)) as is_free_look_recurring, cast(null as VARCHAR(5)) as ma_cust_adv_pgv, cast(null as DATE) as ma_init_freelook_start_date, cast(null as VARCHAR(80)) as ma_init_freelook_start_durn, cast(null as VARCHAR(80)) as ma_init_freelook_start_window, cast(null as DATE) as ma_promo_freelook_start_date, cast(null as VARCHAR(80)) as ma_promo_freelook_start_durn, cast(null as VARCHAR(80)) as ma_promo_freelook_start_window, cast(null as DECIMAL(8, 6)) as ma1_override_amount, cast(null as DECIMAL(5, 2)) as ma2_override_amount, cast(null as DECIMAL(6, 2)) as mai_override_amount, cast(null as DECIMAL(5, 2)) as mam_override_amount, cast(null as DECIMAL(15, 2)) as managed_account_default_salary, cast(null as VARCHAR(80)) as managed_account_fee_type, cast(null as VARCHAR(10)) as managed_account_flag, cast(null as VARCHAR(80)) as managed_accounts_program, cast(null as VARCHAR(80)) as ma_program_adoption_type, cast(null as VARCHAR(80)) as ma_program_default, cast(null as VARCHAR(80)) as ma_program_pricing_model, cast(null as VARCHAR(80)) as market_code, cast(null as VARCHAR(1)) as migration_indicator, cast(null as VARCHAR(80)) as mtf_fee_recovery, cast(null as DECIMAL(10, 2)) as mtf_override_amout, cast(null as VARCHAR(80)) as old_billing_group, cast(null as VARCHAR(80)) as old_fixed_fund_number, cast(null as VARCHAR(80)) as old_product_code, cast(null as VARCHAR(80)) as open_arch_menu_type, cast(null as VARCHAR(80)) as pcf_fee_recovery, cast(null as DECIMAL(8, 2)) as pcf_override_amount, cast(null as VARCHAR(80)) as plan_product_code, cast(null as VARCHAR(55)) as plan_product_short_name, cast(null as VARCHAR(80)) as plan_system_key, cast(null as VARCHAR(80)) as plan_reference_key, cast(null as VARCHAR(80)) as portfolio_blueprint_tier_amt, cast(null as VARCHAR(80)) as ppf_fee_recovery, cast(null as DECIMAL(8, 2)) as ppf_override_amount, cast(null as VARCHAR(80)) as primary_contact_email, cast(null as VARCHAR(80)) as primary_contact_first_name, cast(null as VARCHAR(80)) as primary_contact_last_name, cast(null as VARCHAR(10)) as primary_contact_source_system, cast(null as VARCHAR(80)) as qdia_portfolio_fund_series, cast(tp.tpa_code as VARCHAR(80)) as tpa_code, cast(null as VARCHAR(80)) as rep_id, cast(null as VARCHAR(1)) as roth_ind, cast(null as VARCHAR(80)) as safe_harbor_amount, cast(trim(stpa.name) as VARCHAR(80)) as tpa_name, cast(null as VARCHAR(80)) as safe_harbor_percent, cast(null as VARCHAR(4)) as plan_end_mmdd, plan_address_line_1,cast(null as VARCHAR(40)) as sponsor_address1, plan_address_line_2 ,cast(null as VARCHAR(40)) as sponsor_address2, plan_address_line_3 ,cast(null as VARCHAR(40)) as sponsor_address3, dt.crm_name, dt.crm_email, dt.crm_phone, dt.trustee_name, dt.trustee_email, dt.trustee_phone, cast(null as VARCHAR(100)) as sponsor_city, cast(null as VARCHAR(100)) as sponsor_country, cast(null as VARCHAR(200)) as sponsor_name_line_1, cast(null as VARCHAR(10)) as sponsor_zip_code, cast(null as VARCHAR(80)) as sdbo_status, cast(null as VARCHAR(10)) as uses_contrib_rate_escalator, cast(null as VARCHAR(10)) as uses_eligibility_module, cast(null as VARCHAR(10)) as uses_loan_sweep_module, cast(null as VARCHAR(10)) as vesting_data_source, cast(null as VARCHAR(3)) as sponsor_state, cast(null as VARCHAR(100)) as sponsor_name_line_2, cast(null as VARCHAR(3)) as ss_plan_sept_act_code, cast(null as DATE) as start_date, cast(null as VARCHAR(80)) as superior_plan_name, cast(null as VARCHAR(80)) as superior_plan_reference_key, cast(null as VARCHAR(1)) as usb_pgm_flag, cast(null as VARCHAR(80)) as ma_voya_as_advisor_is_qdia, cast(null as DATE) as wealth_management_end_date, cast(null as VARCHAR(80)) as wealth_mgmt_retirement_allowed, cast(null as DATE) as wealth_management_start_date, cast(null as DATE) as fid_ser_end_date, cast(null as VARCHAR(50)) as fid_ser_fee_ded_meth, cast(null as VARCHAR(6)) as fid_ser_fund_menu, cast(null as VARCHAR(30)) as fid_ser_program_name, cast(null as DATE) as fid_ser_start_date, cast(null as VARCHAR(5)) as product_type, cast(null as VARCHAR(2)) as market_indicator, case when client_id = 'NG' then 'VRP-PB' else 'VRP-SP' end as underlying_source_system, cast(null as varchar(80)) as primary_contact_phone_no, case when source_cycle_date > '9999-12-31' then null else cast(source_cycle_date as date) end as source_cycle_date FROM exn_xxewre01_xxewrpld_jb pld left outer join F986PB_MIS_J986CP1_TPA_DATA_FILE tp on pld.plan_number = tp.plan_code left outer join stars_daily_contact_dat dt on coalesce(dt.plan_id, '-9999') = coalesce(pld.plan_number, '-9999') left outer join slx_tpa_common_daily_dat as stpa on tp.tpa_code= stpa.tpa_code left outer join (select * from  pdab_role_code_helper_csv pt where pt.source_system_nm='CASE PROF' ) as  pr on pld.irc_code= pr.source_system_field_value left outer join  (select plan_id,substring(collect_set(role_key)[0],1,3) as company_code from dss_dc_producerrole_daily_dat group by plan_id) as dss on coalesce(dss.plan_id, '-9999') = coalesce(pld.plan_number, '-9999') left outer join (select collect_set(account_type_code) as account_type_code, plan_number from ( select case when upper(trim(sp.participant_account_type_code)) in ('ALLOC', 'ALOC') then 'ALLOC' else sp.participant_account_type_code end as account_type_code, sp.plan_number from super_omni_newr_particpantaccount_daily_jb_dat sp where sp.plan_number is not null or sp.plan_number <> '' ) group by plan_number ) as ptd on pld.plan_number = ptd.plan_number
